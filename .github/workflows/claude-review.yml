name: Claude review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # src/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®ã¿ã‚’æŠ½å‡º
          git diff --name-only origin/${{ github.base_ref }}..HEAD | \\\
          grep -E '(^src/)' > changed_files.txt || true

          if [ -s changed_files.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Review with Claude
        id: claude_review
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          CLAUDE_MODEL_NAME: ${{ vars.CLAUDE_MODEL_NAME || 'claude-3-5-sonnet-20240620' }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤‰æ›´å†…å®¹ã‚’å–å¾—
          DIFF=$(git diff origin/${{ github.base_ref }}..HEAD -- $(cat changed_files.txt | tr '\n' ' '))

          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒ«ã¨JSONå½¢å¼ã§ã®å‡ºåŠ›ã‚’æŒ‡ç¤ºã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          PROMPT=$(cat <<EOF
ã‚ãªãŸã¯Pythonã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆã®ãƒšã‚¢ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã§ã™ã€‚ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯Poetry, Python 3.12+, Ruff, pytestã‚’ä½¿ç”¨ã—ã€å…¨ã¦ã®ã‚³ãƒ¼ãƒ‰ã¯src/ã«é…ç½®ã•ã‚Œã¾ã™ã€‚
ã“ã‚Œã‚‰ã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãã€ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆã¯å…·ä½“çš„ã«è¨˜è¿°ã—ã€å•é¡ŒãŒãªã„å ´åˆã¯ãã®æ—¨ã‚’ä¼ãˆã¦ãã ã•ã„ã€‚
ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã¯å¿…ãšä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ã—ã¦ãã ã•ã„ã€‚

\`\`\`json
{
  "review_comment": "ã“ã“ã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¿°ã€‚æ”¹å–„ææ¡ˆãŒãªã„å ´åˆã¯ã€ŒLGTM!ã€ãªã©è‚¯å®šçš„ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚",
  "approved": true
}
\`\`\`
â€»æ”¹å–„ææ¡ˆãŒã‚ã‚‹å ´åˆã¯ \`"approved": false\` ã¨ã—ã¦ãã ã•ã„ã€‚

diff:
\`\`\`diff
$DIFF
\`\`\`
EOF
)
          # å®‰å…¨ãªæ–¹æ³•ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
          jq -n \
            --arg model "$CLAUDE_MODEL_NAME" \
            --arg content "$PROMPT" \
            '{model: $model, max_tokens: 4096, messages: [{"role": "user", "content": $content}]}' > request.json

          # Claude APIã«é€ä¿¡ã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          RESPONSE_DATA=$(curl -s -w "\n%{http_code}" -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            --data-binary @request.json)

          HTTP_CODE=$(echo "$RESPONSE_DATA" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE_DATA" | sed '$d')

          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          if [ "$HTTP_CODE" -ne 200 ]; then
            REVIEW_CONTENT="Claude APIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP Status: $HTTP_CODE)ã€‚\n\n\`\`\`\n$RESPONSE_BODY\n\`\`\`"
            APPROVAL="false"
          else
            # Claudeã®è¿”ç­”ã‹ã‚‰JSONéƒ¨åˆ†ã‚’æŠ½å‡º
            CLEANED_JSON=$(echo "$RESPONSE_BODY" | jq -r '.content[0].text' | sed -n '/^{/,/^}/p')
            if [[ -z "$CLEANED_JSON" ]]; then
                REVIEW_CONTENT="Claudeã‹ã‚‰ã®å¿œç­”ãŒäºˆæœŸã›ã¬å½¢å¼ã§ã—ãŸã€‚\n\n\`\`\`\n$(echo "$RESPONSE_BODY" | jq -r '.content[0].text')\n\`\`\`"
                APPROVAL="false"
            else
                REVIEW_CONTENT=$(echo "$CLEANED_JSON" | jq -r '.review_comment')
                APPROVAL=$(echo "$CLEANED_JSON" | jq -r '.approved')
            fi
          fi

          # å®‰å…¨ãªæ–¹æ³•ã§PRã‚³ãƒ¡ãƒ³ãƒˆã®JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
          jq -n --arg body "## ğŸ¤– Claude Code Review\n\n$REVIEW_CONTENT" '{body: $body}' > comment.json

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.json

          # å¾Œç¶šã‚¹ãƒ†ãƒƒãƒ—ã®ãŸã‚ã«outputã‚’è¨­å®š
          echo "approved=$APPROVAL" >> $GITHUB_OUTPUT

      - name: Add automerge label
        if: steps.claude_review.outputs.approved == 'true'
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "automerge"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
