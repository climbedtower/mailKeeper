name: Claude review
on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # ä¸€èˆ¬çš„ãªãƒ†ã‚¹ãƒˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–ã—ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¨æ€ã‚ã‚Œã‚‹å¤‰æ›´ã‚’æŠ½å‡º
          git diff --name-only origin/${{ github.base_ref }}..HEAD | \
          grep -v -E '(^tests?/|^test/|^docs?/|^doc/|\.md$|Pipfile|poetry\.lock|pyproject\.toml)' > changed_files.txt || true

          if [ -s changed_files.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Review with Claude
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          # å¤‰æ›´å†…å®¹ã‚’å–å¾—
          DIFF=$(git diff origin/${{ github.base_ref }}..HEAD -- $(cat changed_files.txt | tr '\n' ' '))

          # æ±ç”¨çš„ãªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ç”Ÿæˆ
          PROMPT="ã‚ãªãŸã¯å¤šè¨€èªã«å¯¾å¿œã§ãã‚‹çµŒé¨“è±Šå¯Œãªã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰å¤‰æ›´ã®è¨€èªã‚’ç‰¹å®šã—ã€ãã®è¨€èªã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼ˆã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã€åŠ¹ç‡æ€§ã€å¯èª­æ€§ãªã©ï¼‰ã«åŸºã¥ã„ã¦ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€æ”¹å–„ææ¡ˆã‚’æ—¥æœ¬èªã§ãã ã•ã„ã€‚\n\n\`\`\`diff\n$DIFF\n\`\`\`"

          # å®‰å…¨ãªæ–¹æ³•ã§APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
          jq -n \
            --arg model "claude-3-5-sonnet-20241022" \
            --arg content "$PROMPT" \
            '{model: $model, max_tokens: 1500, messages: [{"role": "user", "content": $content}]}' > request.json

          # Claude APIã«é€ä¿¡ã—ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
          RESPONSE_DATA=$(curl -s -w "\n%{http_code}" -X POST https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.ANTHROPIC_API_KEY }}" \
            -H "anthropic-version: 2023-06-01" \
            --data-binary @request.json)

          HTTP_CODE=$(echo "$RESPONSE_DATA" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE_DATA" | sed '$d')

          # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          if [ "$HTTP_CODE" -ne 200 ]; then
            REVIEW_CONTENT="Claude APIã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ (HTTP Status: $HTTP_CODE)ã€‚\n\n\`\`\`\n$RESPONSE_BODY\n\`\`\`"
          else
            REVIEW_CONTENT=$(echo "$RESPONSE_BODY" | jq -r '.content[0].text')
          fi

          # å®‰å…¨ãªæ–¹æ³•ã§PRã‚³ãƒ¡ãƒ³ãƒˆã®JSONã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ãå‡ºã™
          jq -n --arg body "## ğŸ¤– Claude Code Review\n\n$REVIEW_CONTENT" '{body: $body}' > comment.json

          # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            --data-binary @comment.json
